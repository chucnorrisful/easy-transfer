<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <style>

        #pb {
            width: 100%;
            background-color: grey;
        }

        #pb-prog {
            width: 1%;
            height: 30px;
            background-color: green;
        }
    </style>
    <title>EasyTransfer</title>
</head>
<body>
<div class="cont">
    <div class="uploadEle">
        <label>Upload Files</label>
        <input id="fileUpload" type="file" name="fileupload" multiple/>
        <button id="upload-button" onclick="uploadFile()"> Upload</button>
    </div>
    <div class="uploadEle">
        <label>Upload Folder</label>
        <input id="fileUploadFolder" type="file" name="fileupload" webkitdirectory directory multiple/>
        <button id="upload-button-folder" onclick="uploadFileFolder()"> Upload</button>
    </div>
</div>
<div class="progCont">
    <label id="progTxt">0%</label>
    <div id="pb">
        <div id="pb-prog"></div>
    </div>
</div>
<script>
    async function uploadFile() {
        await upload("fileUpload")
    }

    async function uploadFileFolder() {
        await upload("fileUploadFolder")
    }

    async function upload(inputName) {
        let inp = document.getElementById(inputName)
        let files = inp.files

        let fileButton = document.getElementById("upload-button")
        let folderButton = document.getElementById("upload-button-folder")

        fileButton.disabled = true
        folderButton.disabled = true

        //calculate progressbar metrics
        let total = 0;
        for (let i = 0; i < files.length; i++) {
            total += files[i].size;
        }

        var progress = document.getElementById("pb-prog");
        var progressText = document.getElementById("progTxt");

        const packetSize = 1024 * 1024; //1 mb at once

        let sentAgg = 0;
        let packetAgg = 0;
        let formData = new FormData();
        for (let fileInd = 0; fileInd < files.length; fileInd++) {
            const nextSize = files[fileInd].size;
            if (packetAgg + nextSize <= packetSize) {
                // it fits; add file and move on
                formData.append("file", files[fileInd]);
                packetAgg += nextSize;
                continue
            }
            if (packetAgg + nextSize > packetSize) {
                //send packet without file, create new form, add file
                await fetch('/upload', {
                    method: "POST",
                    body: formData
                });
                sentAgg += packetAgg;
                let ratio = sentAgg * 100.0 / total;
                progress.style.width = ratio + "%";
                progressText.innerHTML = ratio.toFixed(0) + "% "+formatSizes(sentAgg, total);

                formData = new FormData();
                formData.append("file", files[fileInd]);
                packetAgg = nextSize;
            }
        }

        // send out last packet
        if (packetSize > 0) {
            await fetch('/upload', {
                method: "POST",
                body: formData
            });
            sentAgg += packetAgg
            progress.style.width = "100%";
            progressText.innerHTML = `100% `+formatSizes(sentAgg, total);
        }

        //cleanup/reset

        fileButton.disabled = false
        folderButton.disabled = false

        inp.value = []
    }

    function formatSizes(part, total) {
        const [pt, ptScale] = getByteScale(part)
        const [tot, totScale] = getByteScale(part)
        return `(${pt} ${ptScale} | ${tot} ${totScale})`
    }

    function getByteScale(by) {
        if (by < 1024) return [by, "B"];
        if (by < 1024 * 1024) return [(by / 1024).toFixed(0), "KB"];
        if (by < 1024 * 1024 * 1024) return [(by / 1024 / 1024).toFixed(0), "MB"]
        return [(by / 1024 / 1024 / 1024).toFixed(0), "GB"]
    }
</script>

</body>
</html>
